DROP TABLE if exists fine;
DROP TABLE if exists borrow;

-- Create tables
create table borrow(
    Roll_no int primary key,
    Book_name varchar2(100),
    Name varchar2(100),
    date_of_issue date,
    status char(1)
);

create table fine(
    roll_no int,
    Date_1 date,
    amt float
);

-- Insert sample data
INSERT INTO borrow VALUES(1, 'DBMS', 'Aarav', DATE '2025-10-01', 'I');
INSERT INTO borrow VALUES(2, 'OS', 'Bhavana', DATE '2025-09-20', 'I');
INSERT INTO borrow VALUES(3, 'Networks', 'Chetan', DATE '2025-10-25', 'I');
INSERT INTO borrow VALUES(4, 'HCI', 'Devika', DATE '2025-10-10', 'I');
INSERT INTO borrow VALUES(5, 'SE', 'Eshan', DATE '2025-09-28', 'I');

-- Create the procedure with transaction control
CREATE OR REPLACE PROCEDURE calc_fine (
  p_roll_no IN borrow.Roll_no%TYPE,
  p_name_of_book IN borrow.Book_name%TYPE
)
IS
  v_date_of_issue DATE;
  v_days NUMBER;
  v_fine NUMBER := 0;
BEGIN
  -- Find the book
  SELECT date_of_issue INTO v_date_of_issue
  FROM borrow
  WHERE Roll_no = p_roll_no AND Book_name = p_name_of_book AND status = 'I';
  
  -- Calculate days and fine
  v_days := TRUNC(SYSDATE) - TRUNC(v_date_of_issue);
  
  IF v_days BETWEEN 15 AND 30 THEN
    v_fine := v_days * 5;
  ELSIF v_days > 30 THEN
    v_fine := (30 * 5) + ((v_days - 30) * 50);
  ELSE
    v_fine := 0;
  END IF;
  
  -- Update book status
  UPDATE borrow
  SET status='R'
  WHERE Roll_no = p_roll_no AND Book_name = p_name_of_book;
  
  -- Insert fine only if it's greater than 0
  IF v_fine > 0 THEN
    INSERT INTO fine (roll_no, Date_1, amt) VALUES (p_roll_no, SYSDATE, v_fine);
  END IF;
  
  -- *FIX 1: Save the changes*
  COMMIT;
  DBMS_OUTPUT.PUT_LINE('Book returned. Fine: ' || v_fine);
  
EXCEPTION
  WHEN NO_DATA_FOUND THEN
    -- *FIX 2: Undo any changes if an error occurs*
    ROLLBACK; 
    DBMS_OUTPUT.PUT_LINE('Error: Pending book not found.');
  WHEN OTHERS THEN
    ROLLBACK;
    DBMS_OUTPUT.PUT_LINE('An unknown error occurred.');
END;
/

-- Execution block (Enable server output first!)
SET SERVEROUTPUT ON;

-- Test Case 1: > 30 days (Roll 2)
EXEC calc_fine(2, 'OS');

-- Test Case 2: < 15 days (Roll 3)
EXEC calc_fine(3, 'Networks');

-- Test Case 3: 15-30 days (Roll 4)
EXEC calc_fine(4, 'HCI');

-- Test Case 4: Exception test
EXEC calc_fine(999, 'Bad Book');

-- Show results
SELECT * FROM borrow;
SELECT * FROM fine;